---
# roles/binaryninja/tasks/main.yml

- name: Check if Binary Ninja already installed
  ansible.builtin.stat:
    path: "/opt/binaryninja"
  register: binja_installed

- name: Install Binary Ninja
  when: not binja_installed.stat.exists
  block:
    - name: Install dependencies
      ansible.builtin.apt:
        name:
          - libgl1
          - libxcb-xinerama0
          - libxkbcommon-x11-0
          - libxcb-cursor0
          - libdbus-1-3
        state: present
      become: true

    - name: Download Binary Ninja Free
      ansible.builtin.get_url:
        url: "https://cdn.binary.ninja/installers/binaryninja_free_linux.zip"
        dest: /tmp/binaryninja_free.zip
        mode: '0644'

    - name: Create install directory
      ansible.builtin.file:
        path: /opt/binaryninja
        state: directory
        mode: '0755'
      become: true

    - name: Extract Binary Ninja
      ansible.builtin.unarchive:
        src: /tmp/binaryninja_free.zip
        dest: /opt/
        remote_src: true
      become: true

    - name: Cleanup download
      ansible.builtin.file:
        path: /tmp/binaryninja_free.zip
        state: absent

- name: Create symlink
  ansible.builtin.file:
    src: /opt/binaryninja/binaryninja
    dest: /usr/local/bin/binaryninja
    state: link
  become: true

- name: Create desktop entry
  ansible.builtin.copy:
    dest: /usr/share/applications/binaryninja.desktop
    mode: '0644'
    content: |
      [Desktop Entry]
      Name=Binary Ninja
      Exec=/opt/binaryninja/binaryninja
      Icon=/opt/binaryninja/docs/img/logo.png
      Type=Application
      Categories=Development;Debugger;
  become: true

- name: Verify installation
  ansible.builtin.command:
    cmd: /opt/binaryninja/binaryninja --help
  register: binja_version
  changed_when: false
  failed_when: false

- name: Show status
  ansible.builtin.debug:
    msg: "Binary Ninja: {{ 'installed' if binja_version.rc == 0 else 'install may need manual license acceptance' }}"


- name: Add to PATH in zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} JOHN"
    block: |
      export PATH="/tools/passwords/johnj/:$PATH"
    create: true
